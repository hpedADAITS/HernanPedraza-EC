@startuml Backend Workflow: Processing Pipeline

!define START_BG #C8E6C9
!define PROCESS_BG #BBDEFB
!define DECISION_BG #FFF9C4
!define END_BG #FFCCBC

title Backend Processing Workflow: From Upload to Final Output

start

:1. Receive POST /api/analyze;
note on the right
  Input validation:
  - Path exists
  - Contains .java files
  - Within size limits (50 MB)
end note

if (Valid project?) then (yes)
else (no)
  :Return 400 error;
  end
endif

:2. Build file tree structure;
note on the right
  Process:
  - Scan directory recursively
  - Filter .java files
  - Build hierarchy
  - Extract metadata (line count, size)
end note

:3. Execute ext-finder.js;
note on the right
  Child process execution:
  - Find all .java files
  - Return paths
  - Handle errors
end note

if (Java files found?) then (yes)
else (no)
  :Return 404 - No Java files;
  end
endif

:4. Parse extracted files with JavaParser;
note on the right
  Extraction:
  - Class definitions
  - Method signatures
  - Fields and properties
  - Package structure
  - Annotations
  - Inheritance chains
end note

:5. Build RAG (Retrieval-Augmented Generation);
note on the right
  RAG setup:
  - Chunk files by token budget
  - Build vector embeddings
  - Index for semantic search
  - Store metadata
end note

:6. Prepare IMPLEMENTER prompt;
note on the right
  Token-budgeted prompt:
  - File tree (truncated)
  - Class list
  - Method signatures
  - Tool call instructions
  - Max input: ~3800 tokens
end note

:7. Call LMStudio IMPLEMENTER;
note on the right
  HTTP POST to localhost:1234
  - Model: IMPLEMENTER
  - Tool call format
  - Temperature: 0.2
  - Max output: 800 tokens
end note

:8. Validate tool call response;
note on the right
  Schema validation:
  - Check tool_call_id
  - Verify output structure
  - Match expected fields
  - Validate JSON
end note

if (Tool call valid?) then (yes)
else (no)
  :Log error, retry or skip;
endif

:9. Extract enrichment chunks from RAG;
note on the right
  RAG query:
  - Query: class names + methods
  - Retrieve top-k chunks
  - Sort by relevance
  - Prepare context window
end note

:10. Prepare EXPANDER prompt;
note on the right
  Enrichment prompt:
  - Base markdown template
  - Validated tool results
  - RAG context chunks
  - Behavior inference cues
end note

:11. Call LMStudio EXPANDER;
note on the right
  HTTP POST to localhost:1234
  - Model: EXPANDER
  - Text generation
  - Temperature: 0.3
  - Max output: 800 tokens
end note

:12. Build final Markdown;
note on the right
  Assembly:
  - Package overview
  - Class sections
  - Method details
  - Relationships
  - UML references
end note

:13. Generate PlantUML diagrams;
note on the right
  For each class:
  - Extract relationships
  - Build @startuml syntax
  - Include dependencies
  - Save as .puml
end note

:14. Render .puml to PNG;
note on the right
  Execute PlantUML:
  - Call plantuml.jar
  - Input: .puml files
  - Output: .png images
  - Store in /diagrams
end note

if (Rendering successful?) then (yes)
else (no)
  :Use placeholder diagram;
endif

:15. Convert Markdown to PDF;
note on the right
  Execute Pandoc:
  - Input: .md file
  - Template: custom
  - Output: .pdf file
  - Store in /media/docs
end note

:16. Log execution to history.json;
note on the right
  Store:
  - Timestamp
  - Project path
  - Status (success/failure)
  - Output paths
  - Processing time
end note

:17. Return results to Frontend;
note on the right
  Response object:
  - markdown: text content
  - pdfUrl: download link
  - diagrams: image paths
  - status: success/error
end note

:18. Frontend receives and displays;

stop

@enduml
