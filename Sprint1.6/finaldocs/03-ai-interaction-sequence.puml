@startuml Sequence Diagram: AI Model Interaction

title AI Model Interaction Sequence: IMPLEMENTER and EXPANDER

participant Frontend
participant "Backend\nController"
participant "AI Service"
participant "LMStudio\nIMPLEMENTER"
participant "Schema\nValidator"
participant "LMStudio\nEXPANDER"
participant "Markdown\nBuilder"
participant "Frontend\nResults View"

Frontend -> "Backend\nController": POST /api/analyze (project path)
activate "Backend\nController"

"Backend\nController" -> "AI Service": orchestrateAnalysis()
activate "AI Service"

"AI Service" -> "LMStudio\nIMPLEMENTER": Tool-call prompt\n(file tree + instructions)
activate "LMStudio\nIMPLEMENTER"

note right of "LMStudio\nIMPLEMENTER"
  Input:
  - File structure
  - Class list
  - Method signatures
  - Instructions to extract structure
  - Max tokens: 5000
  - Tool: grep_java_methods
  Tool output: JSON with classes, methods
end note

"LMStudio\nIMPLEMENTER" --> "AI Service": Tool call response\n(JSON with tool_call_id)
deactivate "LMStudio\nIMPLEMENTER"

"AI Service" -> "Schema\nValidator": validateToolCall()
activate "Schema\nValidator"

note right of "Schema\nValidator"
  Validates:
  - tool_call_id exists
  - output field present
  - matches expected schema
  - all required fields present
end note

alt Validation Success
  "Schema\nValidator" --> "AI Service": Valid âœ“
else Validation Failure
  "Schema\nValidator" --> "AI Service": Error (reject)
  "AI Service" --> "Backend\nController": Return error
end

deactivate "Schema\nValidator"

note right of "AI Service"
  Intermediate results stored:
  - classes: [User, Order]
  - methods with signatures
  - package structure
  - dependencies
end note

"AI Service" -> "LMStudio\nEXPANDER": Text expansion prompt\n(raw results + context)
activate "LMStudio\nEXPANDER"

note right of "LMStudio\nEXPANDER"
  Input:
  - Base markdown template
  - Raw class/method data
  - Instructions for enrichment
  - Behavior inference
  - Max tokens: 5000
  
  Output:
  - Enriched descriptions
  - Method documentation
  - Usage recommendations
end note

"LMStudio\nEXPANDER" --> "AI Service": Enriched Markdown
deactivate "LMStudio\nEXPANDER"

"AI Service" -> "Markdown\nBuilder": buildFinalDocumentation()
activate "Markdown\nBuilder"

note right of "Markdown\nBuilder"
  Assembles:
  - Package overview
  - Class breakdowns
  - Method documentation
  - UML diagram references
  - Inheritance trees
end note

"Markdown\nBuilder" --> "AI Service": Final Markdown + metadata
deactivate "Markdown\nBuilder"

"AI Service" --> "Backend\nController": Complete results
deactivate "AI Service"

"Backend\nController" -> Frontend: {markdown, pdfUrl, diagrams}
deactivate "Backend\nController"

Frontend -> "Frontend\nResults View": Display Markdown
activate "Frontend\nResults View"
"Frontend\nResults View" --> Frontend: Render UI + Download buttons
deactivate "Frontend\nResults View"

@enduml
